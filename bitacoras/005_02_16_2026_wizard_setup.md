# Bitácora 005_02_16_2026 hora 11:47:00 wizard_setup

## Qué fue lo que se hizo
- Se creó el wizard interactivo `setup_wizard.sh` que guía al usuario paso a paso para configurar todo el sistema de backups desde cero.
- El wizard tiene 7 pasos: (1) seleccionar disco/partición de backup, (2) seleccionar remote de rclone, (3) verificar Thunderbird, (4) verificar GitHub CLI, (5) generar `config.env`, (6) inicializar volumen con marcador, (7) generar e instalar servicio systemd.
- Se muestra una tabla con particiones disponibles usando `lsblk`, incluyendo columnas de tamaño, espacio disponible, formato y estado de montaje. Se filtra la partición raíz `/` y `/boot*` para evitar selecciones accidentales.
- Se agregó una opción de "ruta manual" para cubrir casos donde el destino no es un dispositivo de bloque (ej: tmpfs, NFS, directorios arbitrarios).
- Se modificó `--install` en `backup_master.sh` para generar el `.service` de systemd dinámicamente en vez de copiar un archivo estático, resolviendo el problema de rutas hardcodeadas (`ExecStart`, `DISPLAY`, `DBUS_SESSION_BUS_ADDRESS`).
- Se eliminó el directorio `systemd/` con el archivo `.service` estático, ya que ahora se genera dinámicamente.
- Se agregó la opción `--setup` en `backup_master.sh` que carga y ejecuta el wizard.

Archivos creados: `src/lib/setup_wizard.sh`.
Archivos modificados: `src/backup_master.sh`.
Archivos eliminados: `systemd/backup-automatico.service`.

## Para qué se hizo
- Hacer el sistema portable y amigable: cualquier persona que clone el repositorio puede configurar todo el sistema ejecutando `./src/backup_master.sh --setup`, sin necesidad de editar archivos manualmente.

## Qué problemas se presentaron
- `lsblk -lpn` devuelve rutas completas (`/dev/nvme0n1p3`) y el `printf` agregaba `/dev/` adicional, resultando en `/dev//dev/nvme0n1p3`.
- La función `_preguntar` usaba `echo ""` decorativo que se capturaba en la sustitución de comando `$()`, contaminando el valor de retorno y causando que la validación numérica fallara ("Selección inválida").
- La partición raíz `/` aparecía como opción seleccionable, permitiendo configurar `BACKUP_DESTINO="/"` lo cual causaba `Permission denied` al crear directorios.
- El tmpfs montado en `/mnt/backup` no aparecía en `lsblk` porque solo lista dispositivos de bloque, no sistemas de archivos virtuales.

## Cómo se resolvieron
- Se eliminó el prefijo `/dev/` del `printf` ya que `lsblk -p` ya incluye la ruta completa.
- Se redirigió el `echo ""` decorativo a `stderr` (`>&2`) para que no contamine el valor capturado por `$()`.
- Se agregaron filtros para excluir la partición raíz (`montaje == "/"`) y particiones de arranque (`montaje == /boot*`).
- Se agregó una opción adicional al final del menú: "Ingresar ruta manualmente", que permite al usuario escribir cualquier ruta existente como destino de backup.

## Qué continúa
- Probar el wizard completo con disco externo real conectado.
- Prueba de integración end-to-end: `--setup` → reinicio → verificar que el servicio systemd ejecuta el backup automáticamente.

*(Archivos clave: [setup_wizard.sh](../src/lib/setup_wizard.sh), [backup_master.sh](../src/backup_master.sh))*
